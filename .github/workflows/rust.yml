name: Rust

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build for Linux
      run: cargo build --release --target x86_64-unknown-linux-gnu
      
    - name: Package for Linux Release
      run: |
        zip -r bimble-linux.zip target/x86_64-unknown-linux-gnu/release/bimble

  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Rust
      uses: actions/setup-rust@v1
      with:
        rust-version: stable
      
    - name: Build for Windows
      run: cargo build --release --target x86_64-pc-windows-msvc
      
    - name: Package for Windows Release
      run: |
        zip -r bimble-windows.zip target/x86_64-pc-windows-msvc/release/bimble.exe

  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    steps:
    - name: Merge artifacts
      run: |
        mkdir release_assets
        cp ${{ github.workspace }}/bimble-linux.zip release_assets/bimble-linux.zip
        cp ${{ github.workspace }}/bimble-windows.zip release_assets/bimble-windows.zip

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v1
        release_name: Release v1.0.1
        body: |
          Release notes for v1.0.1

          Removed mac, source code, targets folders and integrations and kept bimble the command and changed fork and recreated from ground up and updated repo and added readme file added windows integration   
        draft: false
        prerelease: false

    - name: Upload Release Assets
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/bimble-linux.zip
        asset_name: bimble-linux.zip
        asset_content_type: application/zip

    - name: Upload Release Asset
      id: upload-release-asset-windows
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/bimble-windows.zip
        asset_name: bimble-windows.zip
        asset_content_type: application/zip
